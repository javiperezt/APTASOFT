---
alwaysApply: true
---
# ESTRUCTURA DE BASE DE DATOS MYSQL

Base de datos: **APTASOFT_05OCT**
Motor: MySQL/MariaDB
Acceso: Variable global `$mysqli` (definida en conexion.php)

---

## ğŸ—‚ï¸ TABLAS PRINCIPALES Y SUS RELACIONES

### JERARQUÃA DE DATOS

```
empresas (3 empresas: Apta, Sirecons, Epicas)
    â”‚
    â””â”€â”€ obras
         â”œâ”€â”€ presupuestos
         â”‚    â”œâ”€â”€ presupuestos_partidas
         â”‚    â”‚    â””â”€â”€ presupuestos_subpartidas (mano obra, material, externos)
         â”‚    â”‚
         â”‚    â””â”€â”€ presupuestos_capitulos
         â”‚
         â”œâ”€â”€ facturas
         â”‚    â”œâ”€â”€ facturas_partidas
         â”‚    â”œâ”€â”€ facturas_pagos
         â”‚    â””â”€â”€ facturas_capitulos
         â”‚
         â”œâ”€â”€ certificaciones
         â”‚    â””â”€â”€ certificaciones_partidas
         â”‚
         â”œâ”€â”€ gastos
         â”‚    â”œâ”€â”€ gastos_lineas
         â”‚    â”œâ”€â”€ gastos_pagos
         â”‚    â””â”€â”€ gastos_archivos
         â”‚
         â”œâ”€â”€ obras_archivos
         â””â”€â”€ obras_registro_partes (horas trabajadas)

contactos (clientes y proveedores)
empleados (trabajadores)
```

---

## ğŸ“Š DETALLE DE TABLAS

### ğŸ¢ obras
```sql
Campos principales:
- id (PK)
- id_empresa (FK â†’ empresas.id)
- id_contacto (FK â†’ contactos.id) -- Cliente
- id_estado (FK â†’ obras_estados.id) -- 1=PeticiÃ³n, 3=Presupuesto, 6=EjecuciÃ³n, 7=Cerrada, 8=Perdida
- id_canal_entrada (FK â†’ obras_canales_entrada.id)
- id_usuario_asignado (FK â†’ empleados.id)
- titulo
- fecha_inicio
- fecha_fin
- localizacion
- is_active (1=activa, 0=eliminada)

IMPORTANTE: Cuando se elimina una obra (is_active=0), tambiÃ©n se eliminan:
- Todos sus presupuestos
- Todas sus facturas
- Todos sus gastos
- Todas sus certificaciones
```

---

### ğŸ“‹ presupuestos
```sql
Estructura jerÃ¡rquica:
presupuestos â†’ presupuestos_partidas â†’ presupuestos_subpartidas

Campos principales:
- id (PK)
- id_obra (FK â†’ obras.id)
- id_empresa (FK â†’ empresas.id)
- id_contacto (FK â†’ contactos.id)
- id_estado (FK â†’ presupuestos_estados.id) -- 1=Pendiente, 2=Aceptado, 3=Rechazado
- pref_ref (VARCHAR) -- Prefijo "E"
- pref_ref_year (VARCHAR) -- AÃ±o "24", "25"
- ref (VARCHAR) -- NÃºmero "0001", "0002"
- fecha_inicio
- is_active

CÃ³digo completo: pref_ref + pref_ref_year + ref
Ejemplo: E240001 (EstimaciÃ³n aÃ±o 24 nÃºmero 0001)
```

### ğŸ“‹ presupuestos_partidas
```sql
Campos:
- id (PK)
- id_presupuesto (FK â†’ presupuestos.id)
- id_capitulo (FK â†’ capitulos.id)
- partida (VARCHAR) -- Nombre de la partida
- descripcion (TEXT)
- cantidad (DECIMAL)
- fecha_inicio
- fecha_vencimiento
```

### ğŸ“‹ presupuestos_subpartidas
```sql
Campos principales:
- id (PK)
- id_presupuesto_partidas (FK â†’ presupuestos_partidas.id)
- id_categoria (FK â†’ categorias_subpartidas.id) â­ IMPORTANTE
- id_contacto (FK â†’ contactos.id) -- Proveedor
- id_unidad (FK â†’ unidades.id)
- id_iva (FK â†’ iva.id)
- concepto
- descripcion
- cantidad
- precio
- descuento
- subtotal
- total
- fecha_vencimiento
- fecha_prox_intervencion
- is_checked (BOOLEAN) -- Indica si estÃ¡ realizado

â­ CATEGORÃAS (id_categoria):
1 = Mano de obra
2 = Material
3 = Trabajo externo (subcontratas)
```

---

### ğŸ§¾ facturas
```sql
Campos:
- id (PK)
- id_obra (FK â†’ obras.id)
- id_empresa (FK â†’ empresas.id)
- id_contacto (FK â†’ contactos.id) -- Cliente
- id_estado (FK â†’ facturas_estados.id) -- 1=Pendiente, 2=Pagada, 3=Parcialmente pagada
- pref_ref (VARCHAR) -- Siempre "F"
- pref_ref_year (VARCHAR)
- ref (VARCHAR)
- fecha_inicio
- fecha_vencimiento
- is_active

CÃ³digo completo: F240001, F240002...
```

### ğŸ§¾ facturas_partidas
```sql
Campos:
- id (PK)
- id_factura (FK â†’ facturas.id)
- id_capitulo (FK â†’ capitulos.id)
- id_unidad (FK â†’ unidades.id)
- partida
- descripcion
- cantidad
- precio
- subtotal

```

### ğŸ§¾ facturas_pagos
```sql
Campos:
- id (PK)
- id_factura (FK â†’ facturas.id)
- importe (DECIMAL)
- fecha (DATE)
- comentario (TEXT)
- forma_pago (VARCHAR)
- estado (ENUM: 'cobrado', 'pagado')

```

---

### ğŸ’° gastos
```sql
Campos:
- id (PK)
- id_obra (FK â†’ obras.id)
- id_empresa (FK â†’ empresas.id)
- id_contacto (FK â†’ contactos.id) -- Proveedor
- id_estado (FK â†’ gastos_estados.id) -- 1=Pendiente, 2=Pagado
- id_categoria (FK â†’ gastos_categorias.id)
- codigo (VARCHAR)
- fecha_inicio
- fecha_vencimiento
- is_active

CATEGORÃAS:
1 = Gastos generales
2 = Material
3 = Profesionales (Externo)
```

### ğŸ’° gastos_lineas
```sql
Campos:
- id (PK)
- id_gasto (FK â†’ gastos.id)
- id_cuenta_gasto (FK â†’ cuentas_gasto.id) -- Plan contable
- concepto
- subtotal
```

### ğŸ’° gastos_pagos
```sql
Campos:
- id (PK)
- id_gasto (FK â†’ gastos.id)
- importe
- fecha
- comentario
- forma_pago
- estado (ENUM: 'pagado', 'pendiente')
```

### ğŸ’° gastos_archivos
```sql
Campos:
- id (PK)
- id_gasto (FK â†’ gastos.id)
- id_empleado (FK â†’ empleados.id)
- titulo (VARCHAR)
- src (VARCHAR) -- Ruta: "id_gasto/nombre_archivo.ext"

RUTA FÃSICA: docs/gastos/{id_gasto}/{archivo}
```

---

### ğŸ“œ certificaciones
```sql
Campos:
- id (PK)
- id_obra (FK â†’ obras.id)
- id_estado (FK â†’ certificaciones_estados.id) -- 1=Certificado, 2=Facturado
- codigo
- concepto
- fecha
- is_active
```

### ğŸ“œ certificaciones_partidas
```sql
Campos:
- id (PK)
- id_certificacion (FK â†’ certificaciones.id)
- id_presupuesto (FK â†’ presupuestos.id)
- id_capitulo (FK â†’ capitulos.id)
- id_partida_presupuesto (FK â†’ presupuestos_partidas.id)
- partida
- descripcion
- id_unidad
- cantidad
- precio
- total
- cantidad_certificada â­
- precio_certificado â­

```

---

### ğŸ‘· empleados
```sql
Campos:
- id (PK)
- id_rol (FK â†’ roles)
- id_empresa (FK â†’ empresas.id)
- nombre
- correo
- password (hash bcrypt)
- tel
- movil
- nif
- creation_date
- is_active

ROLES:
1 = Administrador/Oficina
2 = Trabajador/TÃ©cnico
```

### â±ï¸ obras_registro_partes
```sql
Campos:
- id (PK)
- id_obra (FK â†’ obras.id)
- id_presupuesto (FK â†’ presupuestos.id)
- id_presupuestos_partidas (FK â†’ presupuestos_partidas.id)
- id_presupuestos_subpartidas (FK â†’ presupuestos_subpartidas.id)
- id_empleado (FK â†’ empleados.id)
- fecha (DATE)
- horas (DECIMAL)
- is_verified (BOOLEAN) -- 0=sin verificar, 1=verificado

Los empleados registran las horas trabajadas en cada subpartida
Permite calcular el coste real de mano de obra
```

---

### ğŸ“‡ contactos
```sql
Campos:
- id (PK)
- id_tipo_organizacion (FK â†’ contactos_tipos_organizacion.id)
- id_tipo_contacto (FK â†’ contactos_tipos.id)
- nombre
- correo
- tel
- movil
- direccion
- poblacion
- provincia
- pais
- cp
- nif
- created
- is_active

TIPOS DE CONTACTO:
1 = Proveedor
2 = Cliente

TIPOS DE ORGANIZACIÃ“N:
1 = Empresa
2 = AutÃ³nomo
```

---

### ğŸ¢ empresas
```sql
Campos:
- id (PK)
- empresa (VARCHAR)
- nombre_comercial
- direccion
- nif
- poblacion
- provincia
- cp
- tel
- tel2
- iban
- src_logo

EMPRESAS DEL SISTEMA:
1 = Apta (APTA LA PLANA S.L.)
2 = Sirecons (SIRECONS, S.L.)
3 = Epicas (EPICAS CASTELLÃ“N, S.L.)
```

---

## ğŸ“ TABLAS AUXILIARES

### capitulos
CapÃ­tulos para organizar partidas de presupuestos/facturas
```sql
- id
- capitulo (VARCHAR)
```

### unidades
```sql
- id
- unidad (VARCHAR)
- simbolo (VARCHAR)

Valores: mÂ², mÂ³, l, kg, g, h, ud
```

### iva
```sql
- id
- iva (VARCHAR)

Valores: 21, 10, 4, 0, 15, 19, 5
```

### obras_estados
```sql
- id
- estado
- orden

Estados:
1 = PeticiÃ³n
3 = Presupuesto
6 = EjecuciÃ³n
7 = Cerrada
8 = Perdida
```

### obras_canales_entrada
```sql
- id
- canal

Valores:
1 = Form web
2 = Llamada
3 = Comercial / Franquiciado
4 = Otros
```

### categorias_subpartidas
```sql
- id
- codigo
- categoria

Valores:
1 = MO (Mano de obra)
2 = MAT (Material)
3 = EXT (Trabajo externo)
```

### cuentas_gasto
Plan contable de gastos (600-799)
```sql
- id
- nombre
- referencia
- is_active

Ejemplo: "Compras de mercaderÃ­as" (600)
```

---